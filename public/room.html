<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Jim-Jam">
  <meta name="theme-color" content="#6366f1">
  <title>Jim-jam Room üéµ</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- CSS Files -->
  <link rel="stylesheet" href="/styles/variables.css">
  <link rel="stylesheet" href="/styles/reset.css">
  <link rel="stylesheet" href="/styles/base.css">
  <link rel="stylesheet" href="/styles/components.css">
  <link rel="stylesheet" href="/styles/room.css">
  <link rel="stylesheet" href="/styles/responsive.css">
</head>
<body>

  <!-- Offline Banner -->
  <div class="offline-banner" id="offlineBanner">You're offline ‚Äî check your connection</div>

  <!-- Name Modal -->
  <div class="modal" id="nameModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Join the Jam</h2>
        <p class="modal-description">What should we call you?</p>
      </div>
      <input
        type="text"
        id="userName"
        class="input"
        placeholder="Your name"
        maxlength="20"
        autofocus
      >
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="joinRoom()">Let's Go</button>
      </div>
    </div>
  </div>

  <!-- Audio Enable Prompt -->
  <div class="audio-prompt" id="audioPrompt" onclick="forceEnableAudio()">
    üîä Tap to enable audio
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon" id="toastIcon">‚ÑπÔ∏è</span>
    <div class="toast-content" id="toastMessage"></div>
    <button class="toast-close" onclick="closeToast()">‚úï</button>
  </div>

  <!-- Header -->
  <header class="room-header">
    <div class="room-header-container">
      <a href="/" class="room-logo">
        <span>üéµ</span>
        <span>Jim-jam</span>
      </a>

      <div class="room-info">
        <span class="room-code-display">
          Room: <strong id="roomCodeDisplay"></strong>
        </span>
        <div class="connection-status" id="connectionStatus">
          <span class="connection-dot" id="connectionDot"></span>
          <span id="connectionText">Connected</span>
        </div>
        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="shareRoom()">
          Share
        </button>
        <a href="/" class="btn btn-ghost" style="padding: 8px 14px; font-size: 13px;">
          Leave
        </a>
      </div>
    </div>
  </header>

  <!-- Mini Player (shows on scroll) -->
  <div class="mini-player" id="miniPlayer">
    <img class="mini-player-thumb" id="miniPlayerThumb" src="" alt="">
    <div class="mini-player-info">
      <div class="mini-player-title" id="miniPlayerTitle"></div>
      <div class="mini-player-artist" id="miniPlayerArtist"></div>
    </div>
    <div class="mini-player-controls">
      <button class="btn-icon" onclick="skipBack()">‚è™</button>
      <button class="btn-icon" onclick="togglePlay()" id="miniPlayPauseBtn">‚ñ∂Ô∏è</button>
      <button class="btn-icon" onclick="playNext()">‚è≠Ô∏è</button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="room-content">

    <!-- Player Section (left) -->
    <section class="player-section">

      <!-- Now Playing ‚Äî big album art -->
      <div class="now-playing-area">
        <div class="album-art-container" id="albumArtContainer">
          <div class="no-music" id="noMusic">
            <span class="no-music-icon">üéµ</span>
            <p class="no-music-text">Search for a song to start jamming!</p>
          </div>
          <img class="album-art" id="albumArt" src="" alt="Album Art">
        </div>

        <div class="track-info" id="trackInfo" style="display: none;">
          <div class="track-title" id="trackTitle">Song Title</div>
          <div class="track-artist" id="trackArtist">Artist Name</div>
        </div>
      </div>

      <!-- Search -->
      <div class="search-container">
        <div class="search-input-wrapper">
          <input
            type="text"
            id="searchInput"
            class="input input-search"
            placeholder="Search YouTube..."
          >
          <button class="btn btn-primary" onclick="if (searchTimeout) clearTimeout(searchTimeout); searchYouTube();">Search</button>
        </div>
        <div class="search-results" id="searchResults"></div>
      </div>

    </section>

    <!-- Sidebar (right) ‚Äî tabbed -->
    <aside class="sidebar">

      <!-- Tab bar -->
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="queue" onclick="switchTab('queue')">
          Queue
        </button>
        <button class="sidebar-tab" data-tab="chat" onclick="switchTab('chat')">
          Chat <span class="unread-badge" id="chatUnreadBadge"></span>
        </button>
        <button class="sidebar-tab" data-tab="users" onclick="switchTab('users')">
          People <span class="sidebar-tab-count" id="userCount">0</span>
        </button>
      </div>

      <!-- Queue Panel -->
      <div class="sidebar-panel queue-panel" id="queuePanel">
        <div class="sidebar-content" id="queueList">
          <div class="queue-empty">Queue is empty</div>
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="sidebar-panel chat-panel hidden-panel" id="chatPanel">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-wrapper">
          <input
            type="text"
            id="chatInput"
            class="input"
            placeholder="Say something..."
          >
          <button class="btn btn-primary" onclick="sendChat()" style="padding: 12px 20px;">
            Send
          </button>
        </div>
      </div>

      <!-- Users Panel -->
      <div class="sidebar-panel users-panel hidden-panel" id="usersPanel">
        <div class="sidebar-content">
          <div id="usersList"></div>
        </div>
      </div>

    </aside>
  </main>

  <!-- Fixed Bottom Player Bar -->
  <div class="player-bar">
    <!-- Left: track thumbnail + info -->
    <div class="player-bar-track">
      <img class="player-bar-thumb" id="playerBarThumb" src="" alt="">
      <div class="player-bar-info">
        <div class="player-bar-title" id="playerBarTitle"></div>
        <div class="player-bar-artist" id="playerBarArtist"></div>
      </div>
    </div>

    <!-- Center: controls + progress -->
    <div class="player-bar-main">
      <div class="player-controls" id="playerControls" style="display: none;">
        <button class="btn-icon" onclick="skipBack()" title="Back 10s">‚è™</button>
        <button class="btn-icon large" onclick="togglePlay()" id="playPauseBtn">‚ñ∂Ô∏è</button>
        <button class="btn-icon" onclick="playNext()" title="Next">‚è≠Ô∏è</button>
      </div>
      <div class="player-progress" id="playerProgress" style="display: none;">
        <div class="progress interactive" id="progressBar">
          <div class="progress-bar" id="progressFill" style="width: 0%"></div>
          <div class="progress-handle" id="progressHandle" style="left: 0%"></div>
        </div>
        <div class="progress-time">
          <span id="currentTime">0:00</span>
          <span id="duration">0:00</span>
        </div>
      </div>
    </div>

    <!-- Right: volume + listener count -->
    <div class="player-bar-right">
      <div class="volume-control">
        <button class="btn-icon" onclick="toggleMute()" id="volumeBtn" title="Mute" style="width:32px;height:32px;font-size:16px;">üîä</button>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100" oninput="setVolume(this.value)">
      </div>
      <span class="player-bar-listeners">
        üë• <span id="listenerCount">0</span>
      </span>
    </div>
  </div>

  <!-- Hidden YouTube Player -->
  <div id="hiddenPlayer">
    <div id="player"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const roomId = window.location.pathname.split('/').pop();
    document.getElementById('roomCodeDisplay').textContent = roomId;

    // Parse carry-over song from home page (e.g. ?vid=xxx&title=...&thumb=...&artist=...)
    const _urlParams = new URLSearchParams(window.location.search);
    const _initVideo = _urlParams.get('vid') ? {
      id: _urlParams.get('vid'),
      title: decodeURIComponent(_urlParams.get('title') || 'Unknown Title'),
      thumbnail: decodeURIComponent(_urlParams.get('thumb') || ''),
      artist: decodeURIComponent(_urlParams.get('artist') || ''),
      source: 'youtube'
    } : null;

    let socket;
    let player;
    let isHost = false;
    let isSyncing = false;
    let syncInterval = null;
    let userName = '';
    let wasPlayingBeforeHidden = false;
    let lastKnownTime = 0;
    let wakeLock = null;

    // ===== SIDEBAR TABS =====

    function switchTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      document.querySelectorAll('.sidebar-panel').forEach(p => {
        p.classList.add('hidden-panel');
      });
      const panel = document.getElementById(tab + 'Panel');
      if (panel) panel.classList.remove('hidden-panel');
    }

    // ===== WAKE LOCK =====

    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => { console.log('Wake Lock released'); });
        }
      } catch (err) {
        console.log('Wake Lock not available:', err.message);
      }
    }

    function releaseWakeLock() {
      if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    // ===== PAGE VISIBILITY =====

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (player && player.getPlayerState) {
          wasPlayingBeforeHidden = player.getPlayerState() === YT.PlayerState.PLAYING;
          lastKnownTime = player.getCurrentTime();
        }
        releaseWakeLock();
      } else {
        if (socket && socket.connected && player) {
          socket.emit('sync-request');
          requestWakeLock();
          let extraSyncCount = 0;
          const extraSyncInterval = setInterval(() => {
            if (extraSyncCount >= 5 || !socket || !socket.connected) {
              clearInterval(extraSyncInterval);
              return;
            }
            socket.emit('sync-request');
            extraSyncCount++;
          }, 2000);
        }
      }
    });

    // ===== YOUTUBE IFRAME API =====

    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScript = document.getElementsByTagName('script')[0];
    firstScript.parentNode.insertBefore(tag, firstScript);

    let userInteracted = false;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        playerVars: {
          autoplay: 1,
          controls: 0,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          enablejsapi: 1,
          fs: 0,
          origin: window.location.origin
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: onPlayerError
        }
      });
    }

    function onPlayerReady(event) {
      player.setVolume(100);
      player.unMute();
    }

    function onPlayerError(event) {
      let errorMessage = 'Video playback error. ';
      switch (event.data) {
        case 2:   errorMessage += 'Invalid video ID.'; break;
        case 5:   errorMessage += 'HTML5 player error.'; break;
        case 100: errorMessage += 'Video not found.'; break;
        case 101:
        case 150: errorMessage += 'Embedding disabled for this video.'; break;
        default:  errorMessage += 'Unknown error.';
      }
      showToast('error', errorMessage + ' Skipping to next...');
      addSystemMessage(errorMessage + ' Skipping...');
      socket.emit('play-next');
    }

    function enableAudio() {
      if (!userInteracted && player) {
        userInteracted = true;
        player.unMute();
        player.setVolume(100);
        document.getElementById('audioPrompt').classList.remove('show');
        if (player.getVideoData && player.getVideoData().video_id) player.playVideo();
      }
    }

    function forceEnableAudio() {
      enableAudio();
      if (player && player.getPlayerState() !== YT.PlayerState.PLAYING) player.playVideo();
    }

    document.addEventListener('click', enableAudio, { once: false });
    document.addEventListener('keydown', enableAudio, { once: false });

    function onPlayerStateChange(event) {
      if (isSyncing) return;
      if (event.data === YT.PlayerState.PLAYING) {
        updatePlayingState(true);
        socket.emit('toggle-play', { isPlaying: true, currentTime: player.getCurrentTime() });
      } else if (event.data === YT.PlayerState.PAUSED) {
        updatePlayingState(false);
        socket.emit('toggle-play', { isPlaying: false, currentTime: player.getCurrentTime() });
      } else if (event.data === YT.PlayerState.ENDED) {
        updatePlayingState(false);
        socket.emit('play-next');
      }
    }

    // ===== ROOM JOIN =====

    function joinRoom() {
      userName = document.getElementById('userName').value.trim() || 'Anonymous';
      document.getElementById('nameModal').classList.add('hidden');

      socket = io();

      socket.on('connect', () => {
        socket.emit('join-room', { roomId, name: userName });
      });

      socket.on('room-state', (state) => {
        isHost = state.isHost;
        updateUsers(state.users);
        updateQueue(state.queue);
        if (state.currentVideo) {
          loadVideo(state.currentVideo.id, state.currentTime, state.isPlaying);
          showNowPlaying(state.currentVideo.title, state.currentVideo.thumbnail, state.currentVideo.artist);
          if (state.isPlaying) updatePlayingState(true);
        } else if (isHost && _initVideo) {
          // Auto-play the song carried over from the home page
          socket.emit('play-video', _initVideo);
        }
      });

      socket.on('video-changed', (data) => {
        loadVideo(data.id, data.currentTime, data.isPlaying);
        showNowPlaying(data.title, data.thumbnail, data.artist);
        if (data.isPlaying) updatePlayingState(true);
      });

      socket.on('play-state-changed', (data) => {
        isSyncing = true;
        updatePlayingState(data.isPlaying);
        if (data.isPlaying) {
          player.seekTo(data.currentTime, true);
          player.playVideo();
        } else {
          player.pauseVideo();
          player.seekTo(data.currentTime, true);
        }
        setTimeout(() => isSyncing = false, 500);
      });

      socket.on('seeked', (data) => {
        isSyncing = true;
        player.seekTo(data.currentTime, true);
        setTimeout(() => isSyncing = false, 500);
      });

      socket.on('sync-response', (data) => {
        if (!player || !player.getCurrentTime) return;
        const currentTime = player.getCurrentTime();
        const diff = Math.abs(currentTime - data.currentTime);
        const playerState = player.getPlayerState();

        isSyncing = true;

        // Always correct play/pause state
        if (!data.isPlaying && playerState === YT.PlayerState.PLAYING) {
          player.pauseVideo();
          if (diff > 1) player.seekTo(data.currentTime, true);
        } else if (data.isPlaying && playerState !== YT.PlayerState.PLAYING) {
          if (diff > 1) player.seekTo(data.currentTime, true);
          player.playVideo();
        } else if (diff > 1) {
          // Same play/pause state but time is off ‚Äî just seek
          player.seekTo(data.currentTime, true);
          if (diff > 3) showToast('success', `Synced to ${formatTime(data.currentTime)}`);
        }

        setTimeout(() => isSyncing = false, 500);
      });

      socket.on('user-joined', (user) => { addSystemMessage(`${user.name} joined the jam`); });
      socket.on('user-left',   (user) => { addSystemMessage(`${user.name} left`); });

      socket.on('queue-updated', (data) => { updateQueue(data.queue); });
      socket.on('chat-message',  (data) => { addChatMessage(data.user, data.message); });

      socket.on('became-host', () => {
        isHost = true;
      });

      socket.on('error', (data) => {
        showToast('error', data.message);
        setTimeout(() => { window.location.href = '/'; }, 2000);
      });

      socket.on('connect_error', () => { showToast('error', 'Connection error. Retrying...'); });

      socket.on('disconnect', (reason) => {
        if (syncInterval) { clearInterval(syncInterval); syncInterval = null; }
        if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        }
        if (reason === 'io server disconnect') {
          showToast('error', 'Disconnected. Reconnecting...');
          socket.connect();
        } else if (reason === 'transport close' || reason === 'transport error') {
          showToast('error', 'Lost connection. Reconnecting...');
        }
      });

      socket.on('reconnect', (attemptNumber) => {
        showToast('success', 'Reconnected!');
        if (!syncInterval) {
          syncInterval = setInterval(() => {
            if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
              socket.emit('sync-request');
            }
          }, 5000);
        }
        socket.emit('join-room', { roomId, name: userName });
      });

      socket.on('reconnect_failed', () => { showToast('error', 'Failed to reconnect. Please refresh.'); });

      socket.on('inactivity-warning', (data) => {
        showToast('warning', data.message);
        addSystemMessage(data.message);
      });

      socket.on('room-closed', (data) => {
        showToast('error', data.message);
        addSystemMessage(data.message);
        setTimeout(() => { window.location.href = '/'; }, 3000);
      });

      syncInterval = setInterval(() => {
        if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
          socket.emit('sync-request');
        }
      }, 5000);
    }

    function cleanup() {
      if (syncInterval) { clearInterval(syncInterval); syncInterval = null; }
      if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
      }
      if (socket && socket.connected) socket.disconnect();
    }

    window.addEventListener('beforeunload', cleanup);

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // ===== PLAYER CONTROLS =====

    function loadVideo(videoId, startTime, autoplay) {
      document.getElementById('noMusic').style.display = 'none';
      isSyncing = true;
      if (player.unMute) player.unMute();
      if (player.setVolume) player.setVolume(100);
      if (autoplay) {
        player.loadVideoById(videoId, startTime);
      } else {
        player.cueVideoById(videoId, startTime);
      }
      setTimeout(() => {
        isSyncing = false;
        if (!userInteracted && player.isMuted && player.isMuted()) {
          document.getElementById('audioPrompt').classList.add('show');
        }
      }, 1000);
    }

    function showNowPlaying(title, thumbnail, artist) {
      document.getElementById('noMusic').style.display = 'none';
      document.getElementById('trackInfo').style.display = 'block';
      document.getElementById('playerControls').style.display = 'flex';
      document.getElementById('playerProgress').style.display = 'block';
      document.getElementById('trackTitle').textContent = title;
      document.getElementById('trackArtist').textContent = artist || 'Unknown Artist';

      const albumArt = document.getElementById('albumArt');
      albumArt.src = thumbnail;
      albumArt.onerror = () => { albumArt.src = 'https://via.placeholder.com/300?text=No+Art'; };
      albumArt.classList.add('active');

      // Update bottom player bar
      const barThumb = document.getElementById('playerBarThumb');
      barThumb.src = thumbnail;
      barThumb.classList.add('visible');
      document.getElementById('playerBarTitle').textContent = title;
      document.getElementById('playerBarArtist').textContent = artist || 'Unknown Artist';
    }

    function togglePlay() {
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    }

    function skipBack() {
      const newTime = Math.max(0, player.getCurrentTime() - 10);
      player.seekTo(newTime, true);
      socket.emit('seek', { currentTime: newTime });
    }

    function playNext() {
      socket.emit('play-next');
    }

    function updatePlayingState(isPlaying) {
      const container = document.getElementById('albumArtContainer');
      const playPauseBtn = document.getElementById('playPauseBtn');
      if (isPlaying) {
        container.classList.add('playing');
        if (playPauseBtn) playPauseBtn.textContent = '‚è∏Ô∏è';
      } else {
        container.classList.remove('playing');
        if (playPauseBtn) playPauseBtn.textContent = '‚ñ∂Ô∏è';
      }
    }

    // ===== USERS =====

    function updateUsers(users) {
      const list = document.getElementById('usersList');
      document.getElementById('userCount').textContent = users.length;
      document.getElementById('listenerCount').textContent = users.length;

      list.innerHTML = users.map(user => `
        <div class="user-item">
          <div class="avatar">${user.name[0].toUpperCase()}</div>
          <span class="user-name">${user.name}</span>
        </div>
      `).join('');
    }

    // ===== QUEUE + DRAG AND DROP =====

    let draggedItem = null;
    let draggedIndex = null;

    function updateQueue(queue) {
      const list = document.getElementById('queueList');
      if (queue.length === 0) {
        list.innerHTML = '<div class="queue-empty">Queue is empty</div>';
      } else {
        list.innerHTML = queue.map((item, i) => `
          <div
            class="queue-item ${i === 0 ? 'current' : ''}"
            draggable="${i > 0}"
            data-index="${i}"
          >
            ${i > 0 ? '<div class="queue-drag-handle">‚ãÆ‚ãÆ</div>' : ''}
            <div class="queue-item-info">
              <div class="queue-item-title">${escapeHtml(item.title)}</div>
              <div class="queue-item-added-by">Added by ${item.addedBy}</div>
            </div>
          </div>
        `).join('');
        setupQueueDragAndDrop();
      }
    }

    function setupQueueDragAndDrop() {
      document.querySelectorAll('.queue-item[draggable="true"]').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend',   handleDragEnd);
        item.addEventListener('dragover',  handleDragOver);
        item.addEventListener('drop',      handleDrop);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragleave', handleDragLeave);
      });
    }

    function handleDragStart(e) {
      draggedItem  = e.currentTarget;
      draggedIndex = parseInt(draggedItem.dataset.index);
      draggedItem.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', draggedItem.innerHTML);
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.queue-item').forEach(item => item.classList.remove('drag-over'));
    }

    function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
    function handleDragEnter(e) { if (e.currentTarget !== draggedItem) e.currentTarget.classList.add('drag-over'); }
    function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');
      if (draggedItem !== e.currentTarget) {
        const dropIndex = parseInt(e.currentTarget.dataset.index);
        socket.emit('reorder-queue', { fromIndex: draggedIndex, toIndex: dropIndex });
      }
      return false;
    }

    // ===== CHAT =====

    function addChatMessage(user, message) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = `
        <div class="chat-user">${user}</div>
        <div class="chat-text">${escapeHtml(message)}</div>
      `;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function addSystemMessage(message) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message system';
      div.innerHTML = `<div class="chat-text">${message}</div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (message) {
        socket.emit('chat-message', { message });
        input.value = '';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
      });
    });

    // ===== SEARCH =====

    let searchTimeout = null;
    let isSearching = false;

    async function searchYouTube(query = null) {
      const searchQuery = query || document.getElementById('searchInput').value.trim();
      const container = document.getElementById('searchResults');

      if (!searchQuery) {
        container.classList.remove('active');
        container.innerHTML = '';
        return;
      }

      isSearching = true;
      container.classList.add('active');
      container.innerHTML = `
        <div class="skeleton-results">
          <div class="skeleton-item"><div class="skeleton-thumb"></div><div class="skeleton-text"><div class="skeleton-line"></div><div class="skeleton-line short"></div></div></div>
          <div class="skeleton-item"><div class="skeleton-thumb"></div><div class="skeleton-text"><div class="skeleton-line"></div><div class="skeleton-line short"></div></div></div>
          <div class="skeleton-item"><div class="skeleton-thumb"></div><div class="skeleton-text"><div class="skeleton-line"></div><div class="skeleton-line short"></div></div></div>
        </div>
      `;

      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(searchQuery)}`);
        const results = await res.json();

        if (results.error) {
          container.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--text-muted)"><p>Search failed: ${results.error}</p></div>`;
          showToast('error', 'Search failed: ' + results.error);
          return;
        }

        if (results.length === 0) {
          container.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--text-muted)"><p>No results found for "${escapeHtml(searchQuery)}"</p></div>`;
          return;
        }

        container.innerHTML = results.map(result => `
          <div class="search-result" onclick="playVideo('${result.id}', '${escapeHtml(result.title).replace(/'/g, "\\'")}', '${result.thumbnail}', '${escapeHtml(result.artist).replace(/'/g, "\\'")}', '${result.source}')">
            <img class="search-result-thumbnail" src="${result.thumbnail}" alt="">
            <div class="search-result-info">
              <div class="search-result-title">${escapeHtml(result.title)}</div>
              <div class="search-result-artist">${escapeHtml(result.artist)} ${result.duration ? '¬∑ ' + result.duration : ''}</div>
            </div>
            ${result.duration ? '<span class="search-result-duration">' + result.duration + '</span>' : ''}
            <div class="search-result-actions">
              <button class="btn btn-primary search-result-btn" onclick="event.stopPropagation(); playVideo('${result.id}', '${escapeHtml(result.title).replace(/'/g, "\\'")}', '${result.thumbnail}', '${escapeHtml(result.artist).replace(/'/g, "\\'")}', '${result.source}')">‚ñ∂ Play</button>
              <button class="btn btn-secondary search-result-btn" onclick="event.stopPropagation(); addToQueue('${result.id}', '${escapeHtml(result.title).replace(/'/g, "\\'")}', '${result.thumbnail}', '${escapeHtml(result.artist).replace(/'/g, "\\'")}', '${result.source}')">+ Queue</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        container.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--text-muted)"><p>Connection error. Please try again.</p></div>`;
        showToast('error', 'Search failed. Check your connection.');
      } finally {
        isSearching = false;
      }
    }

    function handleSearchInput() {
      const query = document.getElementById('searchInput').value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);
      if (!query) { searchYouTube(''); return; }
      searchTimeout = setTimeout(() => searchYouTube(query), 500);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') { if (searchTimeout) clearTimeout(searchTimeout); searchYouTube(); }
        });
      }
    });

    function playVideo(id, title, thumbnail, artist, source) {
      socket.emit('play-video', { id, title, thumbnail, artist, source });
      document.getElementById('searchResults').classList.remove('active');
      document.getElementById('searchInput').value = '';
    }

    function addToQueue(id, title, thumbnail, artist, source) {
      socket.emit('add-to-queue', { id, title, thumbnail, artist, source });
      showToast('success', 'Added to queue!');
    }

    function copyRoomLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        showToast('success', 'Room link copied!');
      }).catch(() => {
        showToast('error', 'Failed to copy link.');
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(type, message) {
      const toast = document.getElementById('toast');
      const icon  = document.getElementById('toastIcon');
      const messageEl = document.getElementById('toastMessage');
      const icons = { success: '‚úì', error: '‚ö†Ô∏è', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
      icon.textContent = icons[type] || icons.info;
      messageEl.textContent = message;
      toast.classList.remove('success', 'error', 'warning', 'info');
      toast.classList.add(type, 'show');
      setTimeout(() => closeToast(), 5000);
    }

    function closeToast() {
      document.getElementById('toast').classList.remove('show');
    }

    // ===== PROGRESS BAR =====

    let progressUpdateInterval = null;

    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
      if (!player || !player.getDuration || !player.getCurrentTime) return;
      const duration    = player.getDuration();
      const currentTime = player.getCurrentTime();
      if (duration > 0) {
        const progress = (currentTime / duration) * 100;
        const progressFill   = document.getElementById('progressFill');
        const progressHandle = document.getElementById('progressHandle');
        const currentTimeEl  = document.getElementById('currentTime');
        const durationEl     = document.getElementById('duration');
        if (progressFill)   progressFill.style.width  = `${progress}%`;
        if (progressHandle) progressHandle.style.left  = `${progress}%`;
        if (currentTimeEl)  currentTimeEl.textContent  = formatTime(currentTime);
        if (durationEl)     durationEl.textContent     = formatTime(duration);
      }
    }

    function startProgressUpdates() {
      if (progressUpdateInterval) clearInterval(progressUpdateInterval);
      progressUpdateInterval = setInterval(updateProgress, 100);
    }

    function stopProgressUpdates() {
      if (progressUpdateInterval) {
        clearInterval(progressUpdateInterval);
        progressUpdateInterval = null;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const progressBar = document.getElementById('progressBar');
      if (progressBar) {
        progressBar.addEventListener('click', (e) => {
          if (!player || !player.getDuration) return;
          const rect = progressBar.getBoundingClientRect();
          const seekTime = (e.clientX - rect.left) / rect.width * player.getDuration();
          player.seekTo(seekTime, true);
          socket.emit('seek', { currentTime: seekTime });
          updateProgress();
        });
      }
    });

    const _originalShowNowPlaying = showNowPlaying;
    showNowPlaying = function(title, thumbnail, artist) {
      _originalShowNowPlaying(title, thumbnail, artist);
      startProgressUpdates();
    };

    const _originalUpdatePlayingState = updatePlayingState;
    updatePlayingState = function(isPlaying) {
      _originalUpdatePlayingState(isPlaying);
      if (isPlaying) {
        startProgressUpdates();
        requestWakeLock();
      } else {
        stopProgressUpdates();
        updateProgress();
        releaseWakeLock();
      }
    };

    const _originalCleanup = cleanup;
    cleanup = function() {
      stopProgressUpdates();
      releaseWakeLock();
      _originalCleanup();
    };

    // ===== VOLUME CONTROL =====

    let currentVolume = 100;
    let isMuted = false;

    function setVolume(val) {
      val = parseInt(val);
      currentVolume = val;
      isMuted = val === 0;
      if (player && player.setVolume) {
        player.setVolume(val);
        if (val === 0) player.mute(); else player.unMute();
      }
      updateVolumeIcon();
    }

    function toggleMute() {
      if (isMuted) {
        isMuted = false;
        const restoreVol = currentVolume > 0 ? currentVolume : 50;
        document.getElementById('volumeSlider').value = restoreVol;
        if (player && player.unMute) { player.unMute(); player.setVolume(restoreVol); }
        currentVolume = restoreVol;
      } else {
        isMuted = true;
        document.getElementById('volumeSlider').value = 0;
        if (player && player.mute) player.mute();
      }
      updateVolumeIcon();
    }

    function updateVolumeIcon() {
      const btn = document.getElementById('volumeBtn');
      if (!btn) return;
      if (isMuted || currentVolume === 0) btn.textContent = 'üîá';
      else if (currentVolume < 50) btn.textContent = 'üîâ';
      else btn.textContent = 'üîä';
    }

    // ===== SHARE (Web Share API + clipboard fallback) =====

    function shareRoom() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: 'Join my Jim-Jam room!', text: 'Come jam with me!', url: url }).catch(() => {});
      } else {
        navigator.clipboard.writeText(url).then(() => {
          showToast('success', 'Room link copied!');
        }).catch(() => {
          showToast('error', 'Failed to copy link.');
        });
      }
    }

    // ===== UNREAD CHAT BADGE =====

    const _originalAddChatMessage = addChatMessage;
    addChatMessage = function(user, message) {
      _originalAddChatMessage(user, message);
      // Show unread badge if chat tab is not active
      const chatTab = document.querySelector('.sidebar-tab[data-tab="chat"]');
      if (chatTab && !chatTab.classList.contains('active')) {
        const badge = document.getElementById('chatUnreadBadge');
        if (badge) badge.classList.add('show');
      }
    };

    const _originalSwitchTab = switchTab;
    switchTab = function(tab) {
      _originalSwitchTab(tab);
      if (tab === 'chat') {
        const badge = document.getElementById('chatUnreadBadge');
        if (badge) badge.classList.remove('show');
      }
    };

    // ===== CONNECTION STATUS =====

    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connectionDot');
      const text = document.getElementById('connectionText');
      if (!dot || !text) return;
      if (connected) {
        dot.classList.remove('disconnected');
        text.textContent = 'Connected';
      } else {
        dot.classList.add('disconnected');
        text.textContent = 'Reconnecting...';
      }
    }

    // Wrap socket events for connection status after socket is created
    const _originalJoinRoom = joinRoom;
    joinRoom = function() {
      _originalJoinRoom();
      if (socket) {
        socket.on('connect', () => updateConnectionStatus(true));
        socket.on('disconnect', () => updateConnectionStatus(false));
        socket.on('reconnect', () => updateConnectionStatus(true));
      }
    };

    // ===== KEYBOARD SHORTCUTS =====

    document.addEventListener('keydown', (e) => {
      // Skip if user is typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch (e.code) {
        case 'Space':
          e.preventDefault();
          togglePlay();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          skipBack();
          break;
        case 'ArrowRight':
          e.preventDefault();
          if (player && player.getCurrentTime && player.seekTo) {
            const newTime = Math.min(player.getDuration(), player.getCurrentTime() + 10);
            player.seekTo(newTime, true);
            socket.emit('seek', { currentTime: newTime });
          }
          break;
        case 'KeyM':
          toggleMute();
          break;
      }
    });

    // ===== MINI PLAYER ON SCROLL =====
    let miniPlayerActive = false;
    let currentVideoTitle = '';
    let currentVideoArtist = '';
    let currentVideoThumb = '';

    const _originalShowNowPlaying2 = showNowPlaying;
    showNowPlaying = function(title, thumbnail, artist) {
      _originalShowNowPlaying2(title, thumbnail, artist);
      currentVideoTitle = title;
      currentVideoArtist = artist || 'Unknown Artist';
      currentVideoThumb = thumbnail;
      // Update mini player info
      document.getElementById('miniPlayerTitle').textContent = title;
      document.getElementById('miniPlayerArtist').textContent = artist || 'Unknown Artist';
      document.getElementById('miniPlayerThumb').src = thumbnail;
    };

    const _originalUpdatePlayingState2 = updatePlayingState;
    updatePlayingState = function(isPlaying) {
      _originalUpdatePlayingState2(isPlaying);
      const miniBtn = document.getElementById('miniPlayPauseBtn');
      if (miniBtn) miniBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
    };

    function checkMiniPlayer() {
      const playerSection = document.querySelector('.player-section');
      if (!playerSection || !currentVideoTitle) return;
      const rect = playerSection.getBoundingClientRect();
      const shouldShow = rect.bottom < 0;
      const miniPlayer = document.getElementById('miniPlayer');
      if (shouldShow && !miniPlayerActive) {
        miniPlayer.classList.add('show');
        miniPlayerActive = true;
      } else if (!shouldShow && miniPlayerActive) {
        miniPlayer.classList.remove('show');
        miniPlayerActive = false;
      }
    }

    window.addEventListener('scroll', checkMiniPlayer, { passive: true });

    // ===== OFFLINE INDICATOR =====
    function updateOnlineStatus() {
      const banner = document.getElementById('offlineBanner');
      if (navigator.onLine) {
        banner.classList.remove('show');
      } else {
        banner.classList.add('show');
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    document.getElementById('userName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinRoom();
    });
  </script>
</body>
</html>
